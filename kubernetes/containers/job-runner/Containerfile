FROM prefecthq/prefect:2.14.21-python3.10

# install gdal, git, wget
RUN apt-get update
RUN apt-get install -y --no-install-recommends \
    gdal-bin \
    libgdal-dev \
    openssh-client \
    git \
    wget \
&& rm -rf /var/lib/apt/lists/*

# install python packages
COPY requirements.txt requirements.txt
# install numpy beforehand, otherwise netcdf4 build step will complain for some reason
RUN pip install numpy
RUN pip install -r requirements.txt --no-cache-dir --no-binary rasterio

COPY prepare.sh /usr/bin/prepare.sh
ENTRYPOINT ["/usr/bin/prepare.sh"]

# run prefect agent
CMD ["prefect", "worker", "start", "-p", "geodata-pool"]
