FROM prefecthq/prefect:2.8.6-python3.8

# install gdal, git, wget
RUN apt-get update
RUN apt-get install -y --no-install-recommends \
    gdal-bin \
    libgdal-dev \
    openssh-client \
    git \
    wget \
&& rm -rf /var/lib/apt/lists/*

# install python packages
COPY job-runner/requirements.txt requirements.txt
RUN pip install -r requirements.txt --no-cache-dir --no-binary rasterio

COPY job-runner/prepare.sh /usr/bin/prepare.sh
ENTRYPOINT ["/usr/bin/prepare.sh"]

# run prefect agent
CMD ["prefect", "agent", "start", "-q", "geodata`"]
